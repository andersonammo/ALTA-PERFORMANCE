<!-- 
    PAINEL DE CONSULTOR - COM POTENCIAL DE SEGUROS E RELAT√ìRIO COMPLETO
    
    Novidades:
    1. Regra de Seguros: 1 √ìculos (Grau ou Sol) = Meta de 1 Seguro.
    2. Relat√≥rio Excel: Agora inclui as colunas de "Meta Ideal" e "Gap" (Oportunidade Perdida) para cada categoria.
    3. Layout: Ajustado para mostrar 3 cards de potencial (Sol, Kits, Seguros).
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Consultor: Alta Performance</title>
    
    <!-- Bibliotecas Visuais e L√≥gicas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'otica-products-v3';
        
        let db, auth;
        let authReady = false;
        
        try {
            if (!firebaseConfig.apiKey && Object.keys(firebaseConfig).length === 0) {
                console.warn("Modo Local Ativo (Firebase n√£o configurado).");
                authReady = true;
            } else {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                        if (!auth.currentUser) await signInAnonymously(auth);
                    }
                };
                initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        authReady = true;
                        document.getElementById('connection-status').innerText = "Nuvem + Local Ativos";
                        document.getElementById('connection-status').className = "mt-6 text-xs text-green-200 font-bold bg-green-800/20 py-1 px-3 rounded-full inline-block";
                    }
                });
            }
        } catch (e) {
            console.error("Erro Firebase:", e);
        }

        // --- FUN√á√ïES DE DADOS ---
        window.getDateKey = function(dayIndex) {
            const today = new Date();
            const dayDiff = dayIndex - (today.getDay() === 0 ? 6 : today.getDay() - 1);
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + dayDiff);
            return targetDate.toISOString().split('T')[0];
        }

        window.saveData = async function(dataObj) {
            if (!window.consultantName) return;
            const dateKey = window.getDateKey(window.currentDayIndex);
            const finalData = { 
                ...dataObj, 
                date: dateKey,
                store: window.storeName,
                consultant: window.consultantName,
                lastUpdated: new Date().toISOString()
            };

            const historyKey = `history_${window.consultantName.replace(/\s+/g, '_').toLowerCase()}`;
            let localHistory = JSON.parse(localStorage.getItem(historyKey) || '{}');
            localHistory[dateKey] = { ...localHistory[dateKey], ...finalData };
            localStorage.setItem(historyKey, JSON.stringify(localHistory));

            const statusEl = document.getElementById('save-status');
            statusEl.classList.remove('opacity-0');

            if (db && authReady) {
                const safeName = window.consultantName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
                const docId = `${safeName}_${dateKey}`;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_reports', docId);
                try { await setDoc(docRef, finalData, { merge: true }); } catch (e) { console.error(e); }
            }
            setTimeout(() => { statusEl.classList.add('opacity-0'); }, 2000);
        };

        window.fetchData = async function(dayIndex) {
            const dateKey = window.getDateKey(dayIndex);
            const historyKey = `history_${window.consultantName.replace(/\s+/g, '_').toLowerCase()}`;
            const localHistory = JSON.parse(localStorage.getItem(historyKey) || '{}');
            let data = localHistory[dateKey] || null;

            if (!data && db && authReady) {
                const safeName = window.consultantName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
                const docId = `${safeName}_${dateKey}`;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_reports', docId);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) data = docSnap.data();
                } catch (e) { console.error(e); }
            }
            return data;
        };

        window.exportToExcel = function() {
            if (!window.consultantName) return;
            const historyKey = `history_${window.consultantName.replace(/\s+/g, '_').toLowerCase()}`;
            const localHistory = JSON.parse(localStorage.getItem(historyKey) || '{}');
            const records = Object.values(localHistory);

            if (records.length === 0) { alert("Sem dados para exportar."); return; }

            const excelData = records.map(item => {
                const entries = parseInt(item.flowEntries) || 0;
                const conv = parseInt(item.flowConversions) || 0;
                const rate = entries > 0 ? ((conv / entries) * 100).toFixed(1) + '%' : '0%';
                
                // C√°lculos de Potencial para o Relat√≥rio
                const grade = parseInt(item.prodGrade) || 0;
                const sun = parseInt(item.prodSun) || 0;
                const kits = parseInt(item.prodKit) || 0;
                const insurance = parseInt(item.prodInsurance) || 0;
                
                const targetSun = grade;
                const targetKit = grade + sun;
                const targetIns = grade + sun;

                const gapSun = Math.max(0, targetSun - sun);
                const gapKit = Math.max(0, targetKit - kits);
                const gapIns = Math.max(0, targetIns - insurance);

                return {
                    "Data": item.date, "Consultor": item.consultant, "Loja": item.store,
                    "Vendas (R$)": item.sales || 0, "Meta (R$)": item.goal || 0,
                    "Entraram": entries, "Compraram": conv, "Convers√£o": rate,
                    "Leads": item.leads || 0, "Agendamentos": item.appointments || 0,
                    
                    // Detalhe de Produtos
                    "Qtd Sol": sun,
                    "Qtd Grau": grade,
                    "Qtd Lentes Ctt": item.prodContact || 0,
                    "Qtd Kits": kits,
                    "Qtd Correntes": item.prodChain || 0,
                    "Qtd Infantil": item.prodKids || 0,
                    "Qtd Seguros": insurance,

                    // Potencial de Vendas (Relat√≥rio)
                    "Meta Solar (2¬™ Pe√ßa)": targetSun,
                    "Perdeu Venda Solar": gapSun,
                    "Meta Kits": targetKit,
                    "Perdeu Venda Kits": gapKit,
                    "Meta Seguros": targetIns,
                    "Perdeu Venda Seguros": gapIns
                };
            });

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio Geral");
            XLSX.writeFile(wb, `Relatorio_${window.consultantName}.xlsx`);
            
            setTimeout(() => {
                const driveLink = "https://drive.google.com/drive/folders/1CU0gUxp3smShCpgzABFQSzVCM__tLW0F?usp=drive_link";
                if(confirm("Baixado! Abrir Google Drive para upload?")) window.open(driveLink, '_blank');
            }, 1000);
        };

        window.db = db; window.auth = auth;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .timeline-line { position: absolute; left: 1.25rem; top: 0; bottom: 0; width: 2px; background-color: #e5e7eb; z-index: 0; }
        .checkbox-custom { appearance: none; width: 1.2em; height: 1.2em; border: 2px solid #0d9488; border-radius: 4px; display: inline-grid; place-content: center; cursor: pointer; }
        .checkbox-custom::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em #0d9488; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .checkbox-custom:checked::before { transform: scale(1); }
        .chart-container { position: relative; width: 100%; height: 220px; }
        .glass-panel { background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- TELA DE ENTRADA -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-yellow-500 px-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <div class="mb-6">
                <span class="text-5xl block mb-2">üëì</span>
                <h1 class="text-2xl font-bold text-gray-800">Painel do Consultor</h1>
                <p class="text-sm text-gray-500">Alta Performance em √ìtica</p>
            </div>
            <form onsubmit="handleEnter(event)" class="space-y-4">
                <div class="text-left">
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1 ml-1">Quem √© voc√™?</label>
                    <input type="text" id="access-name" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none text-lg" placeholder="Seu Nome" required>
                </div>
                <div class="text-left">
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1 ml-1">Nome da Loja</label>
                    <input type="text" id="access-store" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none text-lg" placeholder="Ex: √ìtica Centro" required>
                </div>
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform hover:scale-[1.02] active:scale-95">Acessar Painel</button>
            </form>
            <p id="connection-status" class="mt-6 text-xs text-gray-500 font-medium bg-white/50 inline-block px-2 rounded">Verificando conex√£o...</p>
        </div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="dashboard-view" class="hidden flex flex-col min-h-screen w-full">
        
        <!-- Navbar -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3 w-full md:w-auto">
                        <div class="h-10 w-10 bg-teal-100 rounded-full flex items-center justify-center text-teal-700 font-bold text-xl">C</div>
                        <div class="flex-1">
                            <h1 class="text-lg font-bold text-gray-800 leading-tight"><span id="header-name">Consultor</span></h1>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">√Årea de Trabalho</span>
                                <span id="save-status" class="text-xs font-bold text-green-600 opacity-0 transition-opacity">Salvo ‚úì</span>
                            </div>
                        </div>
                        <button onclick="exportToExcel()" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded-lg shadow transition-colors"><span>üì•</span> Excel</button>
                        <button onclick="logout()" class="md:hidden text-xs text-red-500 font-bold ml-2">Sair</button>
                    </div>
                    
                    <!-- Navega√ß√£o de Abas -->
                    <div class="flex bg-gray-100 p-1 rounded-xl w-full md:w-auto overflow-x-auto">
                        <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 px-4 py-2 rounded-lg text-sm font-bold bg-white shadow text-teal-700 transition-colors whitespace-nowrap">Painel Di√°rio</button>
                        <button onclick="switchTab('products')" id="tab-products" class="flex-1 px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-teal-700 transition-colors whitespace-nowrap">Mix de Produtos</button>
                        <button onclick="switchTab('materials')" id="tab-materials" class="flex-1 px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-teal-700 transition-colors whitespace-nowrap">Materiais</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ABA DASHBOARD (Padr√£o) -->
        <main id="view-dashboard" class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Dia da Semana -->
            <div class="lg:col-span-12 flex bg-white p-2 rounded-xl overflow-x-auto scrollbar-hide border border-gray-200 mb-2">
                <button onclick="setDay(0)" class="day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-day="0">Seg</button>
                <button onclick="setDay(1)" class="day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-day="1">Ter</button>
                <button onclick="setDay(2)" class="day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-day="2">Qua</button>
                <button onclick="setDay(3)" class="day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-day="3">Qui</button>
                <button onclick="setDay(4)" class="day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-day="4">Sex</button>
                <button onclick="setDay(5)" class="day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors" data-day="5">S√°b</button>
            </div>

            <!-- Coluna Esquerda: Cronograma -->
            <div class="lg:col-span-7 flex flex-col gap-6 order-2 lg:order-1">
                <div class="glass-panel p-5 rounded-xl border-l-4 border-teal-500">
                    <h2 class="text-lg font-bold text-gray-800">Cronograma Di√°rio</h2>
                    <p class="text-sm text-gray-500">Siga o fluxo para bater a meta.</p>
                </div>
                <div class="relative pl-4" id="timeline-container"></div>
            </div>

            <!-- Coluna Direita: Ferramentas -->
            <div class="lg:col-span-5 flex flex-col gap-6 order-1 lg:order-2">
                <!-- Resultados -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-gray-800 font-bold mb-4 flex justify-between items-center">
                        Metas e Fluxo <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">Auto-save</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="col-span-2 sm:col-span-1">
                            <label class="text-xs text-gray-500 font-bold mb-1 block">Meta Mensal (R$)</label>
                            <input type="number" id="input-goal" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-lg font-bold text-gray-700 outline-none" value="40000" oninput="handleMetricChange()">
                        </div>
                        <div class="col-span-2 sm:col-span-1">
                            <label class="text-xs text-gray-500 font-bold mb-1 block">J√° Vendido (R$)</label>
                            <input type="number" id="input-sales" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-lg font-bold text-teal-700 outline-none" placeholder="0" oninput="handleMetricChange()">
                        </div>
                        
                        <!-- META INTELIGENTE -->
                        <div class="col-span-2 bg-yellow-50 p-3 rounded-lg border border-yellow-100 mt-2">
                            <p class="text-xs font-bold text-yellow-800 uppercase mb-2 flex justify-between">
                                <span>Planejamento Inteligente</span>
                                <span id="days-left-display" class="font-normal text-yellow-700">Calculando...</span>
                            </p>
                            <div class="flex items-end justify-between">
                                <div>
                                    <label class="text-[10px] text-gray-500 font-bold block">Falta Vender</label>
                                    <p id="remaining-goal-display" class="text-sm font-bold text-gray-700">R$ 0,00</p>
                                </div>
                                <div class="text-right">
                                    <label class="text-[10px] text-gray-500 font-bold block">Meta Di√°ria Necess√°ria</label>
                                    <p id="daily-needed-display" class="text-xl font-bold text-teal-700">R$ 0,00</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-2 bg-teal-50 p-3 rounded-lg border border-teal-100 mt-2">
                            <p class="text-xs font-bold text-teal-800 uppercase mb-2">Fluxo de Atendimento</p>
                            <div class="grid grid-cols-3 gap-3 items-end">
                                <div><label class="text-[10px] text-gray-500 font-bold block">Entraram</label><input type="number" id="input-flow-entries" class="w-full p-1.5 bg-white border border-gray-300 rounded text-sm text-center font-semibold outline-none" placeholder="0" oninput="handleMetricChange()"></div>
                                <div><label class="text-[10px] text-gray-500 font-bold block">Compraram</label><input type="number" id="input-flow-conversions" class="w-full p-1.5 bg-white border border-gray-300 rounded text-sm text-center font-semibold outline-none" placeholder="0" oninput="handleMetricChange()"></div>
                                <div><label class="text-[10px] text-gray-500 font-bold block">Convers√£o</label><div id="conversion-display" class="w-full p-1.5 bg-teal-600 text-white rounded text-sm text-center font-bold">0%</div></div>
                            </div>
                        </div>
                        <div><label class="text-xs text-gray-500 font-bold mb-1 block">Leads</label><input type="number" id="input-leads" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none" placeholder="0" oninput="handleMetricChange()"></div>
                        <div><label class="text-xs text-gray-500 font-bold mb-1 block">Agendamentos</label><input type="number" id="input-appointments" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none" placeholder="0" oninput="handleMetricChange()"></div>
                    </div>
                    <div class="chart-container"><canvas id="performanceChart"></canvas></div>
                </div>

                <!-- Miss√£o -->
                <div class="glass-panel p-6 rounded-xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-teal-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Foco de Hoje</h3>
                    <h2 id="mission-title" class="text-2xl font-bold text-teal-700 mb-4">...</h2>
                    <div class="space-y-3 relative z-10">
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg"><span class="text-xl">üéØ</span><div><p class="text-xs font-bold text-gray-600 uppercase">A√ß√£o Principal</p><p id="mission-main" class="text-sm text-gray-800 font-medium">Carregando...</p></div></div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg"><span class="text-xl">üí°</span><div><p class="text-xs font-bold text-gray-600 uppercase">Dica Digital</p><p id="mission-digital" class="text-sm text-gray-800">Carregando...</p></div></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ABA MIX DE PRODUTOS (NOVO) -->
        <main id="view-products" class="hidden flex-grow max-w-4xl mx-auto px-4 py-6 w-full">
            <div class="glass-panel p-6 rounded-xl border-l-4 border-indigo-500">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Mix de Produtos Vendidos</h2>
                        <p class="text-sm text-gray-500">Insira a quantidade de pe√ßas vendidas hoje.</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full">Atualizado em tempo real</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    <!-- √ìculos de Sol -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-bold text-gray-600 mb-2">üï∂Ô∏è √ìculos de Sol</label>
                        <input type="number" id="input-prod-sun" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>

                    <!-- √ìculos de Grau -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-bold text-gray-600 mb-2">üëì √ìculos de Grau</label>
                        <input type="number" id="input-prod-grade" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>

                    <!-- Lentes de Contato -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-bold text-gray-600 mb-2">üëÅÔ∏è Lentes de Contato</label>
                        <input type="number" id="input-prod-contact" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>

                    <!-- Kit Limpa Lentes -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-bold text-gray-600 mb-2">üíß Kit Limpeza</label>
                        <input type="number" id="input-prod-kit" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>

                    <!-- Correntes -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-bold text-gray-600 mb-2">‚õìÔ∏è Correntes / Acess√≥rios</label>
                        <input type="number" id="input-prod-chain" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>

                    <!-- Infantil -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="block text-sm font-bold text-gray-600 mb-2">üß∏ Linha Infantil</label>
                        <input type="number" id="input-prod-kids" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>

                    <!-- Seguros -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 sm:col-span-3">
                        <label class="block text-sm font-bold text-gray-600 mb-2">üõ°Ô∏è Seguros / Garantia Estendida</label>
                        <input type="number" id="input-prod-insurance" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-lg font-bold text-indigo-600 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0" oninput="handleMetricChange()">
                    </div>
                </div>

                <!-- NOVA √ÅREA: POTENCIAL DE VENDAS -->
                <div class="mt-8 bg-indigo-50 border border-indigo-100 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center gap-2">
                        <span>üöÄ</span> Potencial de Vendas (Oportunidades)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card Solar -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                            <p class="text-xs font-bold text-gray-500 uppercase">2¬™ Pe√ßa (Solar)</p>
                            <p class="text-sm text-gray-600 mt-1">Regra: 1 Grau = 1 Sol</p>
                            <div class="mt-3 flex justify-between items-end">
                                <div>
                                    <span class="text-xs text-gray-400">Meta Ideal</span>
                                    <p id="pot-sun-target" class="text-xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400">Realizado</span>
                                    <p id="pot-sun-actual" class="text-xl font-bold text-indigo-600">0</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <p id="pot-sun-gap" class="text-xs font-bold text-orange-500">Sem dados</p>
                            </div>
                        </div>

                        <!-- Card Kits -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                            <p class="text-xs font-bold text-gray-500 uppercase">Acess√≥rios (Kits)</p>
                            <p class="text-sm text-gray-600 mt-1">Regra: 1 √ìculos = 1 Kit</p>
                            <div class="mt-3 flex justify-between items-end">
                                <div>
                                    <span class="text-xs text-gray-400">Meta Ideal</span>
                                    <p id="pot-kit-target" class="text-xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400">Realizado</span>
                                    <p id="pot-kit-actual" class="text-xl font-bold text-indigo-600">0</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <p id="pot-kit-gap" class="text-xs font-bold text-orange-500">Sem dados</p>
                            </div>
                        </div>

                        <!-- Card Seguros -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                            <p class="text-xs font-bold text-gray-500 uppercase">Seguros / Garantia</p>
                            <p class="text-sm text-gray-600 mt-1">Regra: 1 √ìculos = 1 Seguro</p>
                            <div class="mt-3 flex justify-between items-end">
                                <div>
                                    <span class="text-xs text-gray-400">Meta Ideal</span>
                                    <p id="pot-ins-target" class="text-xl font-bold text-gray-800">0</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400">Realizado</span>
                                    <p id="pot-ins-actual" class="text-xl font-bold text-indigo-600">0</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <p id="pot-ins-gap" class="text-xs font-bold text-orange-500">Sem dados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ABA MATERIAIS -->
        <main id="view-materials" class="hidden flex-grow max-w-4xl mx-auto px-4 py-6 w-full">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 bg-teal-50 border-b border-teal-100">
                    <h2 class="text-2xl font-bold text-teal-800">üìö 50 Scripts para Vender Mais</h2>
                    <p class="text-teal-600 mt-1">Materiais de apoio.</p>
                </div>
                <div class="divide-y divide-gray-100">
                    <details class="group p-4 open:bg-gray-50 transition-all cursor-pointer">
                        <summary class="flex justify-between items-center font-bold text-gray-700"><span>üëã Primeiro Contato</span><span class="text-teal-500 group-open:rotate-180 transition-transform">‚ñº</span></summary>
                        <div class="mt-4 text-sm text-gray-600 space-y-4 pl-4 border-l-2 border-teal-300"><p>"[Nome], meu nome √© [Seu Nome]..."</p></div>
                    </details>
                    <details class="group p-4 open:bg-gray-50 transition-all cursor-pointer">
                        <summary class="flex justify-between items-center font-bold text-gray-700"><span>üí∞ Obje√ß√£o de Pre√ßo</span><span class="text-teal-500 group-open:rotate-180 transition-transform">‚ñº</span></summary>
                        <div class="mt-4 text-sm text-gray-600 space-y-4 pl-4 border-l-2 border-teal-300"><p>"Entendo a preocupa√ß√£o..."</p></div>
                    </details>
                </div>
            </div>
        </main>
    </div>

    <!-- L√ìGICA DE NAVEGA√á√ÉO -->
    <script>
        function switchTab(tabName) {
            ['view-dashboard', 'view-products', 'view-materials'].forEach(id => document.getElementById(id).classList.add('hidden'));
            ['tab-dashboard', 'tab-products', 'tab-materials'].forEach(id => {
                document.getElementById(id).className = "flex-1 px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-teal-700 transition-colors whitespace-nowrap";
            });

            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).className = "flex-1 px-4 py-2 rounded-lg text-sm font-bold bg-white shadow text-teal-700 transition-colors whitespace-nowrap";
        }

        // --- L√ìGICA DE ENTRADA ---
        window.handleEnter = async function(e) {
            e.preventDefault();
            const nameInput = document.getElementById('access-name').value.trim();
            const storeInput = document.getElementById('access-store').value.trim();
            if (!nameInput || !storeInput) { alert("Preencha nome e loja."); return; }
            window.consultantName = nameInput;
            window.storeName = storeInput;
            localStorage.setItem('optical_consultant_name', nameInput);
            localStorage.setItem('optical_store_name', storeInput);
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('header-name').innerHTML = `${nameInput} <span class="text-xs font-normal text-gray-400 block sm:inline">| ${storeInput}</span>`;
            window.loadDayData(window.currentDayIndex);
        };

        window.logout = function() {
            if(confirm("Deseja sair?")) {
                localStorage.removeItem('optical_consultant_name');
                localStorage.removeItem('optical_store_name');
                location.reload();
            }
        };

        // --- CRONOGRAMA ---
        const trainingTopics = [
            { title: "Abertura da Venda", task: "T√©cnica de Abordagem N√£o-Invasiva", desc: "Ler script de sauda√ß√£o e praticar sorriso." },
            { title: "Sondagem", task: "Perguntas Abertas vs Fechadas", desc: "Listar 3 perguntas para descobrir a dor do cliente." },
            { title: "Demonstra√ß√£o", task: "Apresenta√ß√£o de Valor", desc: "Treinar manuseio na frente do cliente." },
            { title: "CVBA", task: "Caracter√≠stica, Vantagem, Benef√≠cio", desc: "Aplicar CVBA em uma lente Multifocal." },
            { title: "Obje√ß√£o", task: "Matriz Pre√ßo/Prazo", desc: "Estudar 3 respostas para 'Est√° caro'." },
            { title: "Fechamento", task: "T√©cnicas Ou/Ou", desc: "Treinar fechamento experimental." }
        ];

        function getDailySchedule(dayIndex) {
            const topic = trainingTopics[dayIndex % 6]; 
            return [
                { time: "08:00 - 09:00", title: "Organiza√ß√£o", tasks: ["Limpeza vitrines", "Conferir OS", "Definir Meta"] },
                { time: "09:00 - 10:00", title: `Treinamento: ${topic.title}`, isTraining: true, tasks: [topic.task, topic.desc] },
                { time: "10:00 - 11:00", title: "Digital", tasks: ["Postar Stories", "Responder Directs"] },
                { time: "11:00 - 12:00", title: "CRM", tasks: ["Ligar Clientes", "Aniversariantes"] },
                { time: "12:00 - 14:00", title: "Almo√ßo", isBreak: true },
                { time: "14:00 - 15:30", title: "Prospec√ß√£o", tasks: ["Visitar Vizinhos", "Entregar Cart√µes"] },
                { time: "15:30 - 17:30", title: "Sal√£o", tasks: ["Atendimento", "Repor vitrine"] },
                { time: "17:30 - 18:00", title: "Fechamento", tasks: ["Relat√≥rio", "Fechar caixa"] }
            ];
        }

        const missions = [
            { day: "Segunda", title: "Planejamento", main: "Ligar para 'indecisos'.", dig: "Story: √ìculos Home Office" },
            { day: "Ter√ßa", title: "Externo", main: "Visita Corporativa.", dig: "Reels: Lentes" },
            { day: "Quarta", title: "Vitrine", main: "Trocar destaque.", dig: "Foto: Detalhe Premium" },
            { day: "Quinta", title: "Ofertas", main: "Resgate antigo.", dig: "Enquete: Qual combina?" },
            { day: "Sexta", title: "Fechamento", main: "Confirmar Agenda.", dig: "V√≠deo: Limpeza" },
            { day: "S√°bado", title: "Vendas", main: "Movimento Loja.", dig: "Story: Bastidores" },
        ];

        window.currentDayIndex = 0;

        document.addEventListener('DOMContentLoaded', () => {
            renderTimeline(getDailySchedule(0));
            initChart();
            const savedName = localStorage.getItem('optical_consultant_name');
            const savedStore = localStorage.getItem('optical_store_name');
            if(savedName) document.getElementById('access-name').value = savedName;
            if(savedStore) document.getElementById('access-store').value = savedStore;
        });

        function renderTimeline(scheduleData) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<div class="timeline-line"></div>';
            scheduleData.forEach((block, idx) => {
                const isBreak = block.isBreak ? 'bg-gray-100 opacity-70' : 'bg-white';
                const isTraining = block.isTraining ? 'border-l-4 border-indigo-500 bg-indigo-50' : 'border-gray-200';
                let iconColor = block.isTraining ? 'bg-indigo-500' : 'bg-teal-500';
                let html = `
                <div class="relative z-10 mb-6 pl-6">
                    <div class="absolute left-0 w-3 h-3 ${iconColor} rounded-full border-2 border-white shadow mt-1.5" style="margin-left: 0.8rem;"></div>
                    <div class="${isBreak} ${isTraining} rounded-lg border p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-teal-600 bg-white/50 px-2 py-1 rounded">${block.time}</span>
                            <h4 class="font-bold text-gray-700">${block.title}</h4>
                        </div>`;
                if (!block.isBreak && block.tasks) {
                    html += `<ul class="space-y-2">`;
                    block.tasks.forEach((task, tIdx) => {
                        html += `<li class="flex items-start gap-2"><input type="checkbox" id="task-${idx}-${tIdx}" class="checkbox-custom mt-1 shrink-0" onclick="handleTaskClick(event)"><span class="text-sm text-gray-600 leading-snug">${task}</span></li>`;
                    });
                    html += `</ul>`;
                } else if (block.isBreak) { html += `<p class="text-xs text-gray-400 italic">Pausa.</p>`; }
                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        window.setDay = async function(dayIndex) {
            window.currentDayIndex = dayIndex;
            document.querySelectorAll('.day-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.day) === dayIndex;
                btn.className = `day-btn flex-1 min-w-[3rem] px-3 py-2 rounded-lg text-sm font-medium transition-colors ${isActive ? 'bg-teal-600 text-white shadow-md' : 'text-gray-500 hover:bg-white'}`;
            });
            const m = missions[dayIndex];
            document.getElementById('mission-title').innerText = m.title;
            document.getElementById('mission-main').innerText = m.main;
            document.getElementById('mission-digital').innerText = m.dig;
            renderTimeline(getDailySchedule(dayIndex));
            await window.loadDayData(dayIndex);
        };

        function calculateSmartGoal(goal, sales) {
            const workingDaysLeft = 20; 
            const remaining = goal - sales;
            const dailyNeeded = workingDaysLeft > 0 ? (remaining / workingDaysLeft) : 0;
            document.getElementById('days-left-display').innerText = `${workingDaysLeft} dias √∫teis (Base)`;
            document.getElementById('remaining-goal-display').innerText = `R$ ${Math.max(0, remaining).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('daily-needed-display').innerText = `R$ ${Math.max(0, dailyNeeded).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function updatePotentials() {
            const grade = parseInt(document.getElementById('input-prod-grade').value) || 0;
            const sun = parseInt(document.getElementById('input-prod-sun').value) || 0;
            const kit = parseInt(document.getElementById('input-prod-kit').value) || 0;
            const insurance = parseInt(document.getElementById('input-prod-insurance').value) || 0;

            // L√≥gica 1: Solar (2¬™ pe√ßa) - Meta: 1 grau = 1 sol
            const targetSun = grade;
            const gapSun = Math.max(0, targetSun - sun);
            
            document.getElementById('pot-sun-target').innerText = targetSun;
            document.getElementById('pot-sun-actual').innerText = sun;
            const sunGapEl = document.getElementById('pot-sun-gap');
            if(grade > 0 && gapSun > 0) { sunGapEl.innerText = `‚ö†Ô∏è Perdeu venda de ${gapSun} pe√ßas`; sunGapEl.className = "text-xs font-bold text-red-500"; }
            else if (grade > 0 && gapSun === 0) { sunGapEl.innerText = `‚úÖ Meta atingida!`; sunGapEl.className = "text-xs font-bold text-green-500"; }
            else { sunGapEl.innerText = "Sem dados de grau"; sunGapEl.className = "text-xs text-gray-400"; }

            // L√≥gica 2: Kits - Meta: (Grau + Sol) = 1 Kit
            const totalGlasses = grade + sun;
            const targetKit = totalGlasses;
            const gapKit = Math.max(0, targetKit - kit);

            document.getElementById('pot-kit-target').innerText = targetKit;
            document.getElementById('pot-kit-actual').innerText = kit;
            const kitGapEl = document.getElementById('pot-kit-gap');
            if(totalGlasses > 0 && gapKit > 0) { kitGapEl.innerText = `‚ö†Ô∏è Perdeu venda de ${gapKit} kits`; kitGapEl.className = "text-xs font-bold text-red-500"; }
            else if (totalGlasses > 0 && gapKit === 0) { kitGapEl.innerText = `‚úÖ Meta atingida!`; kitGapEl.className = "text-xs font-bold text-green-500"; }
            else { kitGapEl.innerText = "Sem vendas de √≥culos"; kitGapEl.className = "text-xs text-gray-400"; }

            // L√≥gica 3: Seguros - Meta: (Grau + Sol) = 1 Seguro
            const targetIns = totalGlasses; // 1 insurance per glasses
            const gapIns = Math.max(0, targetIns - insurance);

            document.getElementById('pot-ins-target').innerText = targetIns;
            document.getElementById('pot-ins-actual').innerText = insurance;
            const insGapEl = document.getElementById('pot-ins-gap');
            if(totalGlasses > 0 && gapIns > 0) { insGapEl.innerText = `‚ö†Ô∏è Perdeu venda de ${gapIns} seguros`; insGapEl.className = "text-xs font-bold text-red-500"; }
            else if (totalGlasses > 0 && gapIns === 0) { insGapEl.innerText = `‚úÖ Meta atingida!`; insGapEl.className = "text-xs font-bold text-green-500"; }
            else { insGapEl.innerText = "Sem vendas de √≥culos"; insGapEl.className = "text-xs text-gray-400"; }
        }

        window.loadDayData = async function(dayIndex) {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            const inputs = ['input-sales', 'input-leads', 'input-appointments', 'input-flow-entries', 'input-flow-conversions',
                            'input-prod-sun', 'input-prod-grade', 'input-prod-contact', 'input-prod-kit', 'input-prod-chain', 'input-prod-kids', 'input-prod-insurance'];
            inputs.forEach(id => document.getElementById(id).value = '');
            if(!document.getElementById('input-goal').value) document.getElementById('input-goal').value = 40000;
            document.getElementById('conversion-display').innerText = "0%";
            updateChart();

            const data = await window.fetchData(dayIndex);
            if(data) {
                if(data.sales) document.getElementById('input-sales').value = data.sales;
                if(data.goal) document.getElementById('input-goal').value = data.goal;
                if(data.leads) document.getElementById('input-leads').value = data.leads;
                if(data.appointments) document.getElementById('input-appointments').value = data.appointments;
                if(data.flowEntries) document.getElementById('input-flow-entries').value = data.flowEntries;
                if(data.flowConversions) document.getElementById('input-flow-conversions').value = data.flowConversions;
                // Produtos
                if(data.prodSun) document.getElementById('input-prod-sun').value = data.prodSun;
                if(data.prodGrade) document.getElementById('input-prod-grade').value = data.prodGrade;
                if(data.prodContact) document.getElementById('input-prod-contact').value = data.prodContact;
                if(data.prodKit) document.getElementById('input-prod-kit').value = data.prodKit;
                if(data.prodChain) document.getElementById('input-prod-chain').value = data.prodChain;
                if(data.prodKids) document.getElementById('input-prod-kids').value = data.prodKids;
                if(data.prodInsurance) document.getElementById('input-prod-insurance').value = data.prodInsurance;

                const ent = parseInt(data.flowEntries) || 0;
                const conv = parseInt(data.flowConversions) || 0;
                if(ent > 0) document.getElementById('conversion-display').innerText = ((conv/ent)*100).toFixed(1) + "%";

                if(data.tasks) {
                    Object.keys(data.tasks).forEach(key => {
                        const cb = document.getElementById(`task-${key}`);
                        if(cb) cb.checked = data.tasks[key];
                    });
                }
                updateChart();
            }
            const g = parseFloat(document.getElementById('input-goal').value) || 40000;
            const s = parseFloat(document.getElementById('input-sales').value) || 0;
            calculateSmartGoal(g, s);
            updatePotentials(); // Atualiza potenciais ao carregar
        };

        window.handleTaskClick = function(e) {
            const allTasks = {};
            document.querySelectorAll('.checkbox-custom').forEach(cb => {
                const idParts = cb.id.replace('task-', '');
                allTasks[idParts] = cb.checked;
            });
            window.saveData({ tasks: allTasks });
        };

        let debounceTimer;
        window.handleMetricChange = function() {
            const entries = parseInt(document.getElementById('input-flow-entries').value) || 0;
            const conversions = parseInt(document.getElementById('input-flow-conversions').value) || 0;
            const rate = entries > 0 ? ((conversions / entries) * 100).toFixed(1) : 0;
            document.getElementById('conversion-display').innerText = rate + "%";

            const goal = parseFloat(document.getElementById('input-goal').value) || 0;
            const sales = parseFloat(document.getElementById('input-sales').value) || 0;
            calculateSmartGoal(goal, sales);
            updatePotentials(); // Atualiza potenciais ao digitar

            updateChart();
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                window.saveData({
                    sales: sales,
                    goal: goal,
                    leads: document.getElementById('input-leads').value,
                    appointments: document.getElementById('input-appointments').value,
                    flowEntries: entries,
                    flowConversions: conversions,
                    // Produtos
                    prodSun: document.getElementById('input-prod-sun').value,
                    prodGrade: document.getElementById('input-prod-grade').value,
                    prodContact: document.getElementById('input-prod-contact').value,
                    prodKit: document.getElementById('input-prod-kit').value,
                    prodChain: document.getElementById('input-prod-chain').value,
                    prodKids: document.getElementById('input-prod-kids').value,
                    prodInsurance: document.getElementById('input-prod-insurance').value
                });
            }, 1000);
        };

        let chart;
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Realizado', 'Meta'],
                    datasets: [{ label: 'Valor (R$)', data: [0, 2000], backgroundColor: ['#0d9488', '#e5e7eb'], borderRadius: 6, barPercentage: 0.6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } } }
            });
        }
        function updateChart() {
            const sales = parseFloat(document.getElementById('input-sales').value) || 0;
            const goal = parseFloat(document.getElementById('input-goal').value) || 2000;
            chart.data.datasets[0].data = [sales, goal];
            chart.data.datasets[0].backgroundColor[0] = sales >= goal ? '#10b981' : '#0d9488';
            chart.update();
        }
    </script>
</body>
</html>
