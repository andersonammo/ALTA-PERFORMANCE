<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Ammo - Alta Performance</title>
    <style>
        :root { 
            --ammo-gold: #D4AF37; 
            --ammo-black: #000000; 
            --ammo-dark-gray: #1a1a1a;
            --ammo-bg: #f4f4f4; 
            --alert-red: #d9534f;
            --success-green: #28a745;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--ammo-bg); color: var(--ammo-dark-gray); padding-bottom: 50px; }
        
        /* TELA LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--ammo-black); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--ammo-gold);
        }
        .login-box { width: 80%; max-width: 400px; text-align: center; padding: 30px; border: 2px solid var(--ammo-gold); border-radius: 10px; background: var(--ammo-dark-gray); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 15px; background-color: var(--ammo-gold); color: var(--ammo-black); font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }

        /* APP */
        #main-app { display: none; }
        .tabs { display: flex; background: var(--ammo-black); padding: 10px; overflow-x: auto; position: sticky; top: 0; z-index: 100; }
        .tab-btn { background: none; border: none; color: white; padding: 12px 20px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .tab-btn.active { border-bottom: 4px solid var(--ammo-gold); color: var(--ammo-gold); }
        
        .tab-content { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* BOT√ïES */
        .btn-action { width: 100%; background: var(--ammo-black); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-whatsapp { background: #25D366; }
        
        /* BOT√ÉO DE RESET TOTAL (VERMELHO) */
        .btn-danger { background: var(--alert-red); margin-top: 20px; border: 2px solid #a00; }
        .btn-danger:hover { background: #c9302c; }

        .metric-box { background: #fff; border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 8px; }
        .metric-val { font-size: 1.4rem; font-weight: 800; color: var(--ammo-black); }
        
        .loss-box { background-color: #fff5f5; border-left: 4px solid var(--alert-red); padding: 15px; margin-bottom: 5px; }
        .success-box { background-color: #f0fff4; border-left: 4px solid var(--success-green); padding: 15px; color: var(--success-green); font-weight: bold; }

        /* DESTAQUE META DI√ÅRIA */
        .daily-target-box {
            background-color: #fffde7;
            border: 2px solid var(--ammo-gold);
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-top: 15px;
        }
        .daily-target-val {
            font-size: 1.6rem;
            color: #d89e00;
            font-weight: 900;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--ammo-gold); margin-top:0;">AMMO OPTICAL</h2>
            <p>√Årea do Consultor</p>
            <input type="text" id="loginConsultor" class="login-input" placeholder="Nome do Consultor">
            <input type="text" id="loginOtica" class="login-input" placeholder="Unidade / √ìtica">
            <button class="btn-login" onclick="realizarLogin()">ENTRAR</button>
        </div>
    </div>

    <div id="main-app">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('dashboard')">Painel Di√°rio</button>
            <button class="tab-btn" onclick="openTab('config')">Configura√ß√µes</button>
            <button class="tab-btn" onclick="openTab('treinamento')">Treinamento</button>
            <button class="tab-btn" onclick="openTab('resumo')">Relat√≥rios</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div style="margin-bottom: 20px; color: #555;">
                Consultor: <strong id="displayNomeUser">...</strong> | <span id="displayOticaUser">...</span>
            </div>

            <div class="card">
                <h3>üéØ Meta Mensal</h3>
                <div class="input-group">
                    <label>Meta (R$)</label>
                    <input type="number" id="metaMensal" placeholder="Sua meta..." oninput="atualizarCalculosMeta()">
                </div>
                <div class="grid-2">
                    <div class="metric-box">
                        <div class="metric-val" id="viewAcumulado">R$ 0,00</div>
                        <small>Acumulado Total</small>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="viewFaltante" style="color:var(--alert-red)">R$ 0,00</div>
                        <small>Falta para Meta</small>
                    </div>
                </div>

                <div class="daily-target-box">
                    <small style="color:#666; font-weight:bold; text-transform:uppercase;">Meta Di√°ria Necess√°ria</small>
                    <div class="daily-target-val" id="metaDiariaSug">R$ 0,00</div>
                    <small style="color:#888; font-size:0.8rem;">(Considerando dias de Seg. a S√°b.)</small>
                </div>
            </div>

            <div class="card">
                <h3>üìä Registro Di√°rio</h3>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Clientes Atendidos</label>
                        <input type="number" id="clientesAtendidos" class="input-dia" oninput="calcTudo()">
                    </div>
                    <div class="input-group">
                        <label>Clientes Compraram</label>
                        <input type="number" id="clientesCompraram" class="input-dia" oninput="calcTudo()">
                    </div>
                </div>
                
                <label>Venda Total Hoje (R$)</label>
                <input type="number" id="vendaDia" class="input-dia" placeholder="0.00" oninput="atualizarCalculosMeta()">

                <h4 style="margin-top:20px; border-bottom:1px solid #eee;">Produtos Vendidos</h4>
                <div class="grid-2">
                    <input type="number" id="prodGrau" class="input-dia" placeholder="Grau" oninput="calcTudo()">
                    <input type="number" id="prodSolar" class="input-dia" placeholder="Solar" oninput="calcTudo()">
                    <input type="number" id="prodInfantil" class="input-dia" placeholder="Infantil">
                    <input type="number" id="prodArmacaoAmmo" class="input-dia" placeholder="Arm. Ammo">
                    <input type="number" id="prodArmacaoGrife" class="input-dia" placeholder="Arm. Grife" oninput="calcTudo()">
                    <input type="number" id="prodLentes" class="input-dia" placeholder="Lentes Ctt">
                    <input type="number" id="prodKit" class="input-dia" placeholder="Kit Limpa" oninput="calcTudo()">
                    <input type="number" id="prodCorrente" class="input-dia" placeholder="Corrente" oninput="calcTudo()">
                    <input type="number" id="prodSeguro" class="input-dia" placeholder="Seguro" oninput="calcTudo()">
                </div>
                
                <button class="btn-action" onclick="enviarDados()">üíæ Salvar e Enviar Planilha</button>
            </div>

            <div class="card">
                <h3>‚ö†Ô∏è An√°lise de Perdas</h3>
                <div id="analisePerdas"><p>Preencha os dados...</p></div>
            </div>
        </div>

        <div id="config" class="tab-content">
            <div class="card">
                <h2>Configura√ß√µes</h2>
                <div class="input-group"><label>Nome</label><input type="text" id="configNome"></div>
                <div class="input-group"><label>Unidade</label><input type="text" id="configOtica"></div>
                <button class="btn-action" onclick="atualizarCadastroInterno()">Salvar Altera√ß√µes</button>
                
                <hr style="margin: 30px 0;">
                
                <h3 style="color:var(--alert-red)">Zona de Reset</h3>
                <p style="font-size:0.9rem;">O bot√£o abaixo apaga <strong>TUDO</strong> e reinicia o app.</p>
                <button class="btn-action btn-danger" onclick="apagarTudoReset()">‚ö†Ô∏è ZERAR TUDO (Reset Geral)</button>
            </div>
        </div>

        <div id="treinamento" class="tab-content">
            <div class="card"><h2>Treinamento</h2><p>Conte√∫dos da Universidade Ammo...</p></div>
        </div>
        <div id="resumo" class="tab-content">
            <div class="card">
                <h2>Relat√≥rio</h2>
                <button class="btn-action btn-whatsapp" onclick="gerarWhatsapp()">üì≤ WhatsApp</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwmhOPcpTlwmELntouLXFdPgcopIAi5gUjVbODFyyjR37_-9SlCjYdxWHxVyo7lcz46/exec'; 

        document.addEventListener('DOMContentLoaded', () => {
            verificarLogin();
            carregarDadosLocais();
        });

        function openTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
        }

        // --- LOGIN & DADOS ---
        function verificarLogin() {
            const user = localStorage.getItem('ammo_consultor');
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('displayNomeUser').innerText = user;
                document.getElementById('displayOticaUser').innerText = localStorage.getItem('ammo_otica');
                document.getElementById('configNome').value = user;
                document.getElementById('configOtica').value = localStorage.getItem('ammo_otica');
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        }

        function realizarLogin() {
            const n = document.getElementById('loginConsultor').value;
            const o = document.getElementById('loginOtica').value;
            if(n && o) {
                localStorage.setItem('ammo_consultor', n);
                localStorage.setItem('ammo_otica', o);
                verificarLogin();
            } else alert('Preencha tudo.');
        }

        function atualizarCadastroInterno() {
            localStorage.setItem('ammo_consultor', document.getElementById('configNome').value);
            localStorage.setItem('ammo_otica', document.getElementById('configOtica').value);
            alert('Atualizado!');
            location.reload();
        }

        function apagarTudoReset() {
            if(confirm("CONFIRMA ZERAR O SISTEMA?\n\n1. Login ser√° apagado.\n2. Meta ser√° apagada.\n3. ACUMULADO TOTAL ser√° zerado.")) {
                document.getElementById('viewAcumulado').innerText = 'R$ 0,00';
                localStorage.clear(); 
                location.reload();    
            }
        }

        // --- C√ÅLCULOS FINANCEIROS ---
        function carregarDadosLocais() {
            if(localStorage.getItem('ammo_meta')) document.getElementById('metaMensal').value = localStorage.getItem('ammo_meta');
            
            fetch(GOOGLE_SCRIPT_URL).then(r=>r.json()).then(d=>{
                localStorage.setItem('ammo_acumulado_sheet', d.acumulado);
                atualizarCalculosMeta();
            }).catch(e=>console.log(e));
        }

        // >>>>>> NOVA FUN√á√ÉO: DIAS √öTEIS (SEG A SAB) <<<<<<
        function calcularDiasUteisRestantes() {
            let hoje = new Date();
            let ano = hoje.getFullYear();
            let mes = hoje.getMonth();
            let ultimoDia = new Date(ano, mes + 1, 0).getDate(); // √öltimo dia do m√™s atual
            
            let uteis = 0;
            
            // Come√ßa a contar de hoje at√© o fim do m√™s
            for (let dia = hoje.getDate(); dia <= ultimoDia; dia++) {
                let dataCheck = new Date(ano, mes, dia);
                let diaSemana = dataCheck.getDay(); // 0 = Domingo, 6 = S√°bado
                
                // Se n√£o for Domingo (0), conta como dia de venda
                if (diaSemana !== 0) {
                    uteis++;
                }
            }
            return uteis > 0 ? uteis : 1; // Evita divis√£o por zero
        }

        function atualizarCalculosMeta() {
            const meta = parseFloat(document.getElementById('metaMensal').value || 0);
            localStorage.setItem('ammo_meta', meta);
            
            const hoje = parseFloat(document.getElementById('vendaDia').value || 0);
            const acumuladoHistorico = parseFloat(localStorage.getItem('ammo_acumulado_sheet') || 0);
            
            // Acumulado Atual = O que j√° estava salvo + O que vendi hoje
            const totalAtual = acumuladoHistorico + hoje;
            const faltante = meta - totalAtual;
            
            // Exibi√ß√£o
            document.getElementById('viewAcumulado').innerText = `R$ ${totalAtual.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
            document.getElementById('viewFaltante').innerText = `R$ ${(faltante > 0 ? faltante : 0).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
            
            // >>>>>> C√ÅLCULO DA META DI√ÅRIA <<<<<<
            if (faltante > 0) {
                const diasRestantes = calcularDiasUteisRestantes();
                const metaDiaria = faltante / diasRestantes;
                document.getElementById('metaDiariaSug').innerText = `R$ ${metaDiaria.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
            } else {
                document.getElementById('metaDiariaSug').innerText = "META BATIDA! üèÜ";
            }
        }

        // --- C√ÅLCULOS PERDAS E TEXTO ---
        function calcTudo() {
            const atend = parseFloat(document.getElementById('clientesAtendidos').value||0);
            const compr = parseFloat(document.getElementById('clientesCompraram').value||0);
            const naoComp = atend - compr;
            const financeiro = (naoComp > 0) ? naoComp * 500 : 0;
            
            const grau = parseInt(document.getElementById('prodGrau').value||0);
            const solar = parseInt(document.getElementById('prodSolar').value||0);
            const kit = parseInt(document.getElementById('prodKit').value||0);
            const grife = parseInt(document.getElementById('prodArmacaoGrife').value||0);
            const seguro = parseInt(document.getElementById('prodSeguro').value||0);
            
            let html = [];
            if(naoComp > 0) html.push(`<div class="loss-box">üìâ ${naoComp} clientes perdidos. Preju√≠zo: R$ ${financeiro}</div>`);
            
            if(grife < grau) html.push(`<div class="loss-box">üëì Falta vender ${grau - grife} Grifes.</div>`);
            if(kit < (grau+solar)) html.push(`<div class="loss-box">üß¥ Falta vender ${grau+solar - kit} Kits.</div>`);
            if(seguro < (grau+solar)) html.push(`<div class="loss-box">üõ°Ô∏è Falta vender ${grau+solar - seguro} Seguros.</div>`);
            
            document.getElementById('analisePerdas').innerHTML = html.length ? html.join('') : '<div class="success-box">‚≠ê Parab√©ns!</div>';
        }

        function obterTextoPerdasLimpo() {
            const atend = parseInt(document.getElementById('clientesAtendidos').value||0);
            const compr = parseInt(document.getElementById('clientesCompraram').value||0);
            const naoComp = atend - compr;
            
            const grau = parseInt(document.getElementById('prodGrau').value||0);
            const solar = parseInt(document.getElementById('prodSolar').value||0);
            const kit = parseInt(document.getElementById('prodKit').value||0);
            const grife = parseInt(document.getElementById('prodArmacaoGrife').value||0);
            const seguro = parseInt(document.getElementById('prodSeguro').value||0);

            let lista = [];
            if (naoComp > 0) lista.push(`${naoComp} clientes perdidos`);
            if (grife < grau) lista.push(`${grau - grife} Grifes`);
            if (kit < (grau+solar)) lista.push(`${grau+solar - kit} Kits`);
            if (seguro < (grau+solar)) lista.push(`${grau+solar - seguro} Seguros`);

            return lista.length > 0 ? lista.join(", ") : "Nenhuma perda";
        }

        function enviarDados() {
            const data = {
                consultor: localStorage.getItem('ammo_consultor'),
                meta: document.getElementById('metaMensal').value || 0,
                vendasDia: document.getElementById('vendaDia').value || 0,
                clientesAtendidos: document.getElementById('clientesAtendidos').value || 0,
                clientesCompraram: document.getElementById('clientesCompraram').value || 0,
                produtos: {
                    grau: document.getElementById('prodGrau').value || 0,
                    solar: document.getElementById('prodSolar').value || 0,
                    infantil: document.getElementById('prodInfantil').value || 0,
                    armacaoAmmo: document.getElementById('prodArmacaoAmmo').value || 0,
                    armacaoGrife: document.getElementById('prodArmacaoGrife').value || 0,
                    lentes: document.getElementById('prodLentes').value || 0,
                    kit: document.getElementById('prodKit').value || 0,
                    corrente: document.getElementById('prodCorrente').value || 0,
                    seguro: document.getElementById('prodSeguro').value || 0
                },
                calculados: {
                    acumulado: parseFloat(localStorage.getItem('ammo_acumulado_sheet') || 0) + parseFloat(document.getElementById('vendaDia').value || 0),
                    perdaDinheiro: (parseInt(document.getElementById('clientesAtendidos').value || 0) - parseInt(document.getElementById('clientesCompraram').value || 0)) * 500,
                    itensPerdidos: obterTextoPerdasLimpo()
                }
            };

            const btn = document.querySelector('.btn-action');
            btn.innerText = "‚è≥ Enviando...";
            btn.disabled = true;

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                alert('‚úÖ Dados salvos!');
                localStorage.setItem('ammo_acumulado_sheet', data.calculados.acumulado);
                document.querySelectorAll('.input-dia').forEach(i => i.value = '');
                calcTudo();
                
                btn.innerText = "üíæ Salvar e Enviar Planilha";
                btn.disabled = false;
            }).catch(err => {
                alert('‚ùå Erro: ' + err);
                btn.innerText = "üíæ Salvar e Enviar Planilha";
                btn.disabled = false;
            });
        }
        
        function gerarWhatsapp() {
            const nome = localStorage.getItem('ammo_consultor');
            const venda = document.getElementById('vendaDia').value;
            window.open(`https://wa.me/?text=Relatorio ${nome}: Venda R$ ${venda}`, '_blank');
        }
    </script>
</body>
</html>
